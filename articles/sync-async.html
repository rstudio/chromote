<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Synchronous vs. asynchronous usage • chromote</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Synchronous vs. asynchronous usage">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chromote</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/chromote.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/commands-and-events.html">Commands and events</a></li>
    <li><a class="dropdown-item" href="../articles/sync-async.html">Synchronous vs. asynchronous usage</a></li>
    <li><a class="dropdown-item" href="../articles/which-chrome.html">Choosing which Chrome-based browser to use</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/example-loading-page.html">Loading a page reliably</a></li>
    <li><a class="dropdown-item" href="../articles/example-screenshot.html">Taking a screenshot of a web page</a></li>
    <li><a class="dropdown-item" href="../articles/example-extract-text.html">Extracting text from a web page</a></li>
    <li><a class="dropdown-item" href="../articles/example-attach-existing.html">Attaching to existing tabs</a></li>
    <li><a class="dropdown-item" href="../articles/example-authentication.html">Websites that require authentication</a></li>
    <li><a class="dropdown-item" href="../articles/example-custom-headers.html">Setting custom headers</a></li>
    <li><a class="dropdown-item" href="../articles/example-custom-user-agent.html">Setting custom user agent</a></li>
    <li><a class="dropdown-item" href="../articles/example-remote-hosts.html">Chrome on remote hosts</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/chromote/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Synchronous vs. asynchronous usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/chromote/blob/main/vignettes/sync-async.Rmd" class="external-link"><code>vignettes/sync-async.Rmd</code></a></small>
      <div class="d-none name"><code>sync-async.Rmd</code></div>
    </div>

    
    
<p>By default, when you call methods from a <code>Chromote</code> or
<code>ChromoteSession</code> object, it operates in
<strong>synchronous</strong> mode. For example, when you call a command
function (like <code>b$Page$navigate()</code>), a command message is
sent to the headless browser, the headless browser executes that
command, and it sends a response message back. When the R process
receives the response, it converts it from JSON to an R object and the
function returns that value. During this time, the R process is blocked;
no other R code can execute.</p>
<p>The methods in Chromote/ChromoteSession objects can also be called in
<strong>asynchronous</strong> mode. In async mode, a command function
fires off a message to the browser, and then the R process continues
running other code; when the response comes back at some time in the
future, the R process calls another function and passes the response
value to it.</p>
<p>There are two different ways of using async with Chromote. The first
is with <a href="https://rstudio.github.io/promises/" class="external-link">promises</a> (note
that these are not the regular R-language promises; these are similar to
JavaScript promises for async programming.) The second way is with
callbacks: you call methods with a <code>callback_</code> argument.
Although callbacks are initially easier to use than promises, once you
start writing more complex code, managing callbacks becomes very
difficult, especially when error handling is involved. For this reason,
this document will focus mostly on promises instead of callback-style
programming.</p>
<p>When Chromote methods are called in synchronous mode, under the hood,
they are implemented with asynchronous functions, and then waiting for
the asynchronous functions to resolve.</p>
<blockquote>
<p><strong>Technical note: About the event loop</strong></p>
<p>When methods are called asynchronously, the R process will run
callbacks and promises using an event loop provided by the <a href="https://github.com/r-lib/later" class="external-link">later</a> package. This event loop
is very similar to the one used in JavaScript, which is explained in
depth by <a href="https://youtu.be/8aGhZQkoFbQ" class="external-link">Philip Roberts in this
video</a>. One important difference between JavaScript’s event loop and
the one provided by <strong>later</strong>’s is that in JavaScript, the
event loop only runs when the call stack is empty (essentially, when the
JS runtime is idle); with <strong>later</strong> the event loop
similarly runs when the call stack is empty (when the R console is
idle), but it can also be run at any point by calling
<code><a href="https://r-lib.github.io/later/reference/run_now.html" class="external-link">later::run_now()</a></code>.</p>
<p>There is another important difference between the JS event loop and
the one used by Chromote: Chromote uses <em>private event loops</em>
provided by <a href="https://github.com/r-lib/later" class="external-link">later</a>. Running
the private event loop with <code>run_now()</code> will not interfere
with the global event loop. This is crucial for being able to run
asynchronous code in a way that appears synchronous.</p>
</blockquote>
<div class="section level2">
<h2 id="why-use-async">Why use async?<a class="anchor" aria-label="anchor" href="#why-use-async"></a>
</h2>
<p>The synchronous API is easier to use than the asynchronous one. So
why would you want to use the async API? Here are some reasons:</p>
<ul>
<li>The async API allows you to send commands to the browser that may
take some time for the browser to complete, and they will not block the
R process from doing other work while the browser executes the
command.</li>
<li>The async API lets you send commands to multiple browser “tabs” and
let them work in parallel.</li>
</ul>
<p>On the other hand, async programming can make it difficult to write
code that proceeds in a straightforward, linear manner. Async
programming may be difficult to use in, say, an analysis script.</p>
<p>When using Chromote interactively at the R console, it’s usually best
to just call methods synchronously. This fits well with a iterative,
interactive data analysis workflow.</p>
<p>When you are <em>programming</em> with Chromote instead of using it
interactively, it is in many cases better to call the methods
asynchronously, because it allows for better performance. In a later
section, we’ll see how to write asynchronous code with Chromote that can
be run either synchronously or asynchronously. This provides the best of
both worlds.</p>
<p>To see this in action, we’ll first start a new chromote session:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/chromote/">chromote</a></span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ChromoteSession.html">ChromoteSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="async-commands">Async commands<a class="anchor" aria-label="anchor" href="#async-commands"></a>
</h2>
<p>When a method is called in synchronous mode, it blocks until the
browser sends back a response, and then it returns the value, converted
from JSON to an R object. For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Synchronous</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 5</span></span>
<span><span class="co">#&gt;  $ protocolVersion: chr "1.3"</span></span>
<span><span class="co">#&gt;  $ product        : chr "HeadlessChrome/98.0.4758.102"</span></span>
<span><span class="co">#&gt;  $ revision       : chr "@273bf7ac8c909cde36982d27f66f3c70846a3718"</span></span>
<span><span class="co">#&gt;  $ userAgent      : chr "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/98.0.4758.102 Safari/537.36"</span></span>
<span><span class="co">#&gt;  $ jsVersion      : chr "9.8.177.11"</span></span></code></pre></div>
<p>In async mode, there are two ways to use the value that the browser
sends to the R process. One is to use the <code>callback_</code>
argument with <code>wait_=FALSE</code>. The <code>wait_=FALSE</code>
tells it to run the command in async mode; instead of returning the
value from the browser, it returns a promise. For example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Async with callback</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span>, callback_ <span class="op">=</span> <span class="va">str</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Promise [pending]&gt;</span></span>
<span><span class="co">#&gt; List of 5</span></span>
<span><span class="co">#&gt;  $ protocolVersion: chr "1.3"</span></span>
<span><span class="co">#&gt;  $ product        : chr "HeadlessChrome/98.0.4758.102"</span></span>
<span><span class="co">#&gt;  $ revision       : chr "@273bf7ac8c909cde36982d27f66f3c70846a3718"</span></span>
<span><span class="co">#&gt;  $ userAgent      : chr "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/98.0.4758.102 Safari/537.36"</span></span>
<span><span class="co">#&gt;  $ jsVersion      : chr "9.8.177.11"</span></span></code></pre></div>
<p>Notice that the function returned
<code>&lt;Promise [pending]&gt;</code>, and then it printed out the
data. We’ll come back to the promise part.</p>
<blockquote>
<p><strong>Technical note</strong></p>
<p>When you pass a function as <code>callback_</code>, that function is
used as the first step in the promise chain that is returned.</p>
</blockquote>
<p>If you run the command in a code block (or a function), the entire
code block will finish executing before the callback can be executed.
For example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span>, callback_ <span class="op">=</span> <span class="va">str</span><span class="op">)</span></span>
<span>  <span class="fl">1</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; List of 5</span></span>
<span><span class="co">#&gt;  $ protocolVersion: chr "1.3"</span></span>
<span><span class="co">#&gt;  $ product        : chr "HeadlessChrome/98.0.4758.102"</span></span>
<span><span class="co">#&gt;  $ revision       : chr "@273bf7ac8c909cde36982d27f66f3c70846a3718"</span></span>
<span><span class="co">#&gt;  $ userAgent      : chr "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/98.0.4758.102 Safari/537.36"</span></span>
<span><span class="co">#&gt;  $ jsVersion      : chr "9.8.177.11"</span></span></code></pre></div>
<p>In the code above, it executes the <code>1+1</code> and returns the
value before the <code>str</code> callback can be executed on the
message from the browser.</p>
<p>If you want to store the value from the browser, you can write a
callback that stores the value like so:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This will extract the product field</span></span>
<span><span class="va">product</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span>, callback_ <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">msg</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">product</span> <span class="op">&lt;&lt;-</span> <span class="va">msg</span><span class="op">$</span><span class="va">product</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Promise [pending]&gt;</span></span>
<span><span class="co"># Wait for a moment, then run:</span></span>
<span><span class="va">product</span></span>
<span><span class="co">#&gt; [1] "HeadlessChrome/98.0.4758.102"</span></span></code></pre></div>
<p>But to get the value, you need to wait for the callback to execute
before you can use the value. Waiting for a value is simple when running
R interactively – you can just add a
<code>message("message arrived")</code> call in the callback and wait
for it before running the next line of code – but waiting for the value
is not easy to do using ordinary straight-line coding. Fortunately,
Chromote has a way to wait for async operations, which we’ll see
later.</p>
<p>The other way of using the value is to use <em>promises</em>. If
<code>wait_=FALSE</code> and no <code>callback_</code> is passed to the
command, then it will simply return a promise. Promises have many
advantages over plain old callbacks: they are easier to chain, and they
provide better error-handling capabilities. You can <em>chain</em> more
steps to the promise: when the promise resolves – that is, when the
message is received from the browser – it will run the next step in the
promise chain.</p>
<p>Here’s an example that uses promises to print out the version
information. Note that the surrounding curly braces are there to
indicate that this whole thing must be run as a block without any idle
time in between the function calls – if you were to run the code in the
R console line-by-line, the browser would send back the message and the
promise would resolve before you called <code>p$then()</code>, which is
where you tell the promise what to do with the return value. (The curly
braces aren’t strictly necessary – you could run the code inside the
braces in a single paste operation and have the same effect.)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">p</span><span class="op">$</span><span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">product</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Wait for a moment, then prints:</span></span>
<span><span class="co">#&gt; [1] "HeadlessChrome/98.0.4758.102"</span></span></code></pre></div>
<p>Here are some progressively more concise ways of achieving the same
thing. As you work with promises, you will see these various forms of
promise chaining. For more information, see the <a href="https://rstudio.github.io/promises/" class="external-link">promises
documentation</a>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/promises/" class="external-link">promises</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Chained method call to $then()  </span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">product</span><span class="op">)</span>  </span>
<span><span class="op">}</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Regular function pipe to promises::then() function </span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rstudio.github.io/promises/reference/then.html" class="external-link">then</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">product</span><span class="op">)</span>  </span>
<span><span class="op">}</span><span class="op">)</span>  </span>
<span></span>
<span></span>
<span><span class="co"># Promise-pipe to anonymous function, which must be wrapped in parens</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span> <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">product</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Promise-pipe to an expression (which gets converted to a function with the first argument `.`)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">product</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co"># Promise-pipe to a named function, with parentheses</span></span>
<span><span class="va">print_product</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">msg</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">msg</span><span class="op">$</span><span class="va">product</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span> <span class="fu">print_product</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Promise-pipe to a named function, without parentheses</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Browser</span><span class="op">$</span><span class="fu">getVersion</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span> <span class="va">print_product</span></span></code></pre></div>
<p>The earlier example where we found the dimensions of a DOM element
using CSS selectors was done with the synchronous API and
<code>%&gt;%</code> pipes. The same can be done in async mode by
switching from the regular pipe to the promise-pipe, and calling all the
methods with <code>wait_=FALSE</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="st">".sidebar"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">nodeId</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Or, more verbosely:</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="st">".sidebar"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">value</span><span class="op">$</span><span class="va">nodeId</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Each step in the promise chain uses the value from the previous step,
via <code>.</code> or <code>value</code>. Note that not all asynchronous
code works in such a linear, straightforward way. Sometimes it is
necessary to save data from intermediate steps in a broader-scoped
variable, if it is to be used in a later step in the promise chain.</p>
</div>
<div class="section level2">
<h2 id="turning-asynchronous-code-into-synchronous-code">Turning asynchronous code into synchronous code<a class="anchor" aria-label="anchor" href="#turning-asynchronous-code-into-synchronous-code"></a>
</h2>
<p>There may be times, especially when programming with Chromote, where
you want to wait for a promise to resolve before continuing. To do this,
you can use the Chromote or ChromoteSession’s <code>wait_for()</code>
method.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A promise chain</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="st">".sidebar"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">nodeId</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span><span class="op">$</span><span class="fu">wait_for</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ model:List of 6</span></span>
<span><span class="co">#&gt;   ..$ content:List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 128</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 292</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 292</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 128</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ padding:List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ border :List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ margin :List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : int 15</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1030</span></span>
<span><span class="co">#&gt;   .. ..$ : int 15</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1030</span></span>
<span><span class="co">#&gt;   ..$ width  : int 195</span></span>
<span><span class="co">#&gt;   ..$ height : int 960</span></span></code></pre></div>
<p>This documentation will refer to this technique as
<em>synchronizing</em> asynchronous code. The way that
<code>wait_for()</code> works is that it runs the Chromote object’s
private event loop until the promise has resolved. Because the event
loop is <em>private</em>, running it will not interfere with the global
event loop, which, for example, may used by Shiny to serve a web
application.</p>
<p>The <code>$wait_for()</code> method will return the value from the
promise, so instead of putting the <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> in the chain, you
call <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> on the value returned by
<code>$wait_for()</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="st">".sidebar"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">nodeId</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="fu">wait_for</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ model:List of 6</span></span>
<span><span class="co">#&gt;   ..$ content:List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 128</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 292</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 292</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 128</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ padding:List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ border :List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   .. ..$ : num 112</span></span>
<span><span class="co">#&gt;   .. ..$ : num 988</span></span>
<span><span class="co">#&gt;   ..$ margin :List of 8</span></span>
<span><span class="co">#&gt;   .. ..$ : int 15</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : int 28</span></span>
<span><span class="co">#&gt;   .. ..$ : num 308</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1030</span></span>
<span><span class="co">#&gt;   .. ..$ : int 15</span></span>
<span><span class="co">#&gt;   .. ..$ : num 1030</span></span>
<span><span class="co">#&gt;   ..$ width  : int 195</span></span>
<span><span class="co">#&gt;   ..$ height : int 960</span></span></code></pre></div>
<p>There are some methods in Chromote and ChromoteSession objects which
are written using asynchronous method calls, but conditionally use
<code>wait_for()</code> so that they can be called either synchronously
or asynchronously. The <code>$screenshot()</code> method works this way,
for example. You can call <code>b$screenshot(wait_=TRUE)</code> (which
is the default) for synchronous behavior, or
<code>b$screenshot(wait_=FALSE)</code> for async behavior.</p>
<p>If you want to write a function that can be called in either sync or
async mode, you can use this basic structure: First, construct a promise
chain by calling the CDP methods with <code>wait_=FALSE</code>. Then, at
the end, if the user used <code>wait_=TRUE</code>, wait for the promise
to resolve; otherwise, simply return the promise.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">getBoxModel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">b</span>, <span class="va">selector</span> <span class="op">=</span> <span class="st">"html"</span>, <span class="va">wait_</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>    <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="va">selector</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>    <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">nodeId</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">wait_</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">b</span><span class="op">$</span><span class="fu">wait_for</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">p</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Synchronous call</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">b</span>, <span class="st">".sidebar"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Asynchronous call</span></span>
<span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">b</span>, <span class="st">".sidebar"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>But, you might be wondering, if we want a synchronous API, why not
simply write the synchronous code by calling the individual methods
synchronously, and using a normal pipe to connect them, as in:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getDocument</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">querySelector</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">root</span><span class="op">$</span><span class="va">nodeId</span>, <span class="st">".sidebar"</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">DOM</span><span class="op">$</span><span class="fu">getBoxModel</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">nodeId</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>There are two reasons for this. The first is that this would require
a duplication of all the code for the sync and async code paths. Another
reason is that the internal async code can be written to send multiple
independent command chains to the ChromoteSession (or multiple
ChromoteSessions), and they will be executed concurrently. If there are
multiple promise chains, you can do something like the following to wait
for all of them to resolve:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Starting with promises p1, p2, and p3, create a promise that resolves only</span></span>
<span><span class="co"># after they have all been resolved.</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/promises/reference/promise_all.html" class="external-link">promise_all</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="fu">wait_for</span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="async-events">Async events<a class="anchor" aria-label="anchor" href="#async-events"></a>
</h2>
<p>In addition to <em>commands</em> The Chrome DevTools Protocol also
has <em>events</em>. These are messages that are sent from the browser
to the R process when various browser events happen.</p>
<p>As an example, it can be a bit tricky to find out when to take a
screenshot. When you send the browser a command to navigate to a page,
it sends a response immediately, but it may take several more seconds
for it to actually finish loading that page. When it does, the
<code>Page.loadEventFired</code> event will be fired.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ChromoteSession.html">ChromoteSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Navigate and wait for Page.loadEventFired.</span></span>
<span><span class="co"># Note: these lines are put in a single code block to ensure that there is no</span></span>
<span><span class="co"># idle time in between.</span></span>
<span><span class="op">{</span></span>
<span>  <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ timestamp: num 683</span></span></code></pre></div>
<p>With the synchronous API, the call to
<code>b$Page$loadEventFired()</code> will block until Chromote receives
a <code>Page.loadEventFired</code> message from the browser. However,
with the async promise API, you would write it like this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">}</span> <span class="op"><a href="https://rstudio.github.io/promises/reference/pipes.html" class="external-link">%...&gt;%</a></span></span>
<span>  <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">}</span></span>
<span></span>
<span><span class="co"># Or, more verbosely:</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">$</span></span>
<span>  <span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>There will be a short delay after running the code before the value
is printed.</p>
<p>However, even this is not perfectly reliable, because in some cases,
the browser will navigate to the page before it receives the
<code>loadEventFired</code> command from Chromote. If that happens, the
load even will have already happened before the browser starts waiting
for it, and it will hang. The correct way to deal with this is to issue
the <code>loadEventFired</code> command <em>before</em> navigating to
the page, and then wait for the <code>loadEventFired</code> promise to
resolve.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This is the correct way to wait for a page to load with async and then chain more commands</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># A promise chain of more commands after the page has loaded</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="fu">then</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If you want to block until the page has loaded, you can once again
use <code>wait_for()</code>. For example:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span>, wait_ <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># wait_for returns the last value in the chain, so we can call str() on it</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="fu">wait_for</span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ timestamp: num 683</span></span></code></pre></div>
<blockquote>
<p><strong>Technical note</strong></p>
<p>The Chrome DevTools Protocol itself does not automatically enable
event notifications. Normally, you would have to call the
<code>Page.enable</code> method to turn on event notifications for the
Page domain. However, Chromote saves you from needing to do this step by
keeping track of how many callbacks there are for each domain. When the
number of event callbacks for a domain goes from 0 to 1, Chromote
automatically calls <code>$enable()</code> for that domain, and when it
goes from 1 to 0, it it calls <code>$disable()</code>. See
<code><a href="../articles/commands-and-events.html">vignette("commands-and-events")</a></code> for more details.</p>
</blockquote>
<p>In addition to async events with promises, they can also be used with
regular callbacks. For example:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>callback_ <span class="op">=</span> <span class="va">str</span><span class="op">)</span></span></code></pre></div>
<p>This tells Chromote to call <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> (which prints to the
console) on the message value every single time that a
<code>Page.loadEventFired</code> event message is received. It will
continue doing this indefinitely. (Calling an event method this way also
increments the event callback counter.)</p>
<p>When an event method is called with a callback, the return value is a
function which will cancel the callback, so that it will no longer fire.
(The canceller function also decrements the event callback counter. If
you lose the canceller function, there is no way to decrement the
callback counter back to 0.)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cancel_load_event_callback</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">loadEventFired</span><span class="op">(</span>callback_ <span class="op">=</span> <span class="va">str</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each of these will cause the callback to fire.</span></span>
<span><span class="va">n1</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.r-project.org/"</span><span class="op">)</span></span>
<span><span class="va">n2</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://cran.r-project.org/"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cancel_load_event_callback</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># No longer causes the callback to fire.</span></span>
<span><span class="va">n3</span> <span class="op">&lt;-</span> <span class="va">b</span><span class="op">$</span><span class="va">Page</span><span class="op">$</span><span class="fu">navigate</span><span class="op">(</span><span class="st">"https://www.rstudio.com/"</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/wch" class="external-link">Winston Chang</a>, <a href="http://schloerke.com" class="external-link">Barret Schloerke</a>, <a href="https://garrickadenbuie.com" class="external-link">Garrick Aden-Buie</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
